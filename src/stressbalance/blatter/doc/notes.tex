\documentclass{article}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amssymb,hyperref}

\begin{document}

\section{Strong formulation}
\label{sec:strong-formulation}
Define the effective strain rate tensor $M$
\begin{equation}
  \label{eq:5}
  M = \left(
  \begin{array}{ccc}
  4 u_x + 2 v_y & u_y + v_x & u_z\\
  u_y + v_x & 2 u_x + 4 v_y & v_z
  \end{array}
\right)
\end{equation}
Then the Blatter stress balance equations are
\begin{equation}
  \label{eq:6}
  - \nabla\cdot(\eta M) = \rho g \nabla s,
\end{equation}
where $\eta$ is the effective viscosity and $s$ is the surface elevation.

This is equivalent to
\begin{equation}
  \label{eq:7}
  \begin{aligned}
    \left(\eta (4 u_x + 2 v_y)\right)_x + \left(\eta (u_y + v_x)\right)_y + \left(\eta u_z\right)_z + \rho g s_x &= 0,\\
    \left(\eta (2 u_x + 4 v_y)\right)_y + \left(\eta (u_y + v_x)\right)_x + \left(\eta v_z\right)_z + \rho g s_y &= 0,
  \end{aligned}
\end{equation}
\section{Weak formulation}
\label{sec:weak-formulation}

Product rule says
\begin{align*}
  \nabla \cdot (v X) &= \nabla v \cdot X + v \nabla \cdot X\\
  v\nabla \cdot X &= \nabla\cdot(v X) - \nabla v \cdot X.
\end{align*}

Moreover, the divergence theorem states that
\begin{align*}
  \int_\Omega \nabla\cdot (v X) &= \int_{\partial \Omega} (v X)\cdot \vec n\, ds
\end{align*}

Now, multiplying (\ref{eq:6}) by a test function $\psi$ and integrating by parts, we get
\newcommand{\rhs}{\int_\Omega \psi \rho g \nabla s}
\begin{align}
  -\int_\Omega \psi \nabla\cdot(\eta M) &= \rhs\\
  -\int_\Omega \nabla\cdot (\psi \eta M) + \int_\Omega \nabla \psi \cdot (\eta M) &= \rhs\\
  -\int_{\partial \Omega} (\psi \eta M)\cdot \vec n\, ds + \int_\Omega \psi\cdot (\eta M) &= \rhs\\
  \rhs + \int_\Omega \psi\cdot (\eta M) &= - \int_{\partial \Omega} (\psi \eta M)\cdot \vec n\, ds
\end{align}


\section{Computing the Jacobian}
\label{sec:jacobian}

\newcommand{\diff}[2]{\frac{\partial {#1}}{\partial {#2}}}
\newcommand{\dphi}[2][i]{\diff{\varphi_{#1}}{#2}}
\newcommand{\exponent}{\frac{1-n}{2n}}

\newcommand{\dux}{\diff{u}{x}}
\newcommand{\duy}{\diff{u}{y}}
\newcommand{\duz}{\diff{u}{z}}
\newcommand{\dvx}{\diff{v}{x}}
\newcommand{\dvy}{\diff{v}{y}}
\newcommand{\dvz}{\diff{v}{z}}
\newcommand{\deta}{\diff{\eta}{\gamma}}
\newcommand{\jw}{|J|\,w}
\newcommand{\dgdu}{\diff{\gamma}{u}}
\newcommand{\dgdv}{\diff{\gamma}{v}}
\newcommand{\p}[1]{\left(#1\right)}

\begin{eqnarray}
  \label{eq:3}
  \eta &=& \frac{B}{2} \p{\gamma + \frac{\varepsilon_{0}}{2}}^{\exponent}\\
  \diff{\eta}{\gamma} &=& \frac{B}{2} \cdot \exponent \cdot \p{\gamma + \frac{\varepsilon_{0}}{2} }^{\exponent-1}\\
  &=& \eta \cdot \exponent \cdot \p{\gamma + \frac{\varepsilon_{0}}{2} }^{-1}.
\end{eqnarray}

\begin{equation}
  \label{eq:2}
  \gamma = \p{\dux}^{2} + \dvy^{2} + \dux \dvy + \frac14 \p{\duy + \dvx}^{2} + \frac14 \p{\duz}^{2} + \frac14 \p{\dvz}^{2}
\end{equation}

\begin{eqnarray}
  \label{eq:1}
  \diff{\gamma}{u_{i}} &=& 2\dux \diff{\dux}{u_{i}} + 2\dvy \diff{\dvy}{u_{i}} + \diff{\dux}{u_{i}}\dvy + \dux\diff{\dvy}{u_{i}}
  +\frac 14 \cdot 2 \p{\duy + \dvx}\p{\diff{\duy}{u_{i}} + \diff{\dvx}{u_{i}} }\\
  &+& \frac 14 \cdot 2 \duz \diff{\duz}{u_{i}}
  + \frac 14 \cdot 2 \dvz \diff{\dvz}{u_{i}} \nonumber\\
  &=& 2\dux\dphi{x} + \dvy\dphi{x} + \frac 12 \dphi{y}\p{\duy + \dvx} + \frac 12 \duz \dphi{z}\\
  \diff{\gamma}{v_{i}} &=& 2\dux \diff{\dux}{v_{i}} + 2\dvy \diff{\dvy}{v_{i}} + \diff{\dux}{v_{i}}\dvy + \dux\diff{\dvy}{v_{i}}
  +\frac 14 \cdot 2 \p{\duy + \dvx}\p{\diff{\duy}{v_{i}} + \diff{\dvx}{v_{i}} }\\
  &+& \frac 14 \cdot 2 \duz \diff{\duz}{v_{i}} + \frac 14 \cdot 2 \dvz \diff{\dvz}{v_{i}} \nonumber\\
  &=& 2\dvy\dphi{y} + \dux\dphi{y} + \frac 12 \dphi{x}\p{\duy + \dvx} + \frac 12 \dvz \dphi{z}.
\end{eqnarray}

\subsection{Element contribution}
\label{sec:element-matrix}


Picard part
\begin{eqnarray*}
 K_{i,j,u,u} &+=& \dphi{x}\,\jw\,\eta\,4\dphi[j]{x} + \dphi{y}\,\jw\,\eta\,\dphi[j]{y} + \dphi{z}\,\jw\,\eta\,\dphi[j]{z};\\
  K_{i,j,u,v} &+=& \dphi{x}\,\jw\,\eta\,2\dphi[j]{y} + \dphi{y}\,\jw\,\eta\,\dphi[j]{x};\\
  K_{i,j,v,u} &+=& \dphi{y}\,\jw\,\eta\,2\dphi[j]{x} + \dphi{x}\,\jw\,\eta\,\dphi[j]{y};\\
  K_{i,j,v,v} &+=& \dphi{y}\,\jw\,\eta\,4\dphi[j]{y} + \dphi{x}\,\jw\,\eta\,\dphi[j]{x} + \dphi{z}\,\jw\,\eta\,\dphi[j]{z};\\
\end{eqnarray*}

Extra Newton terms
\begin{eqnarray*}
  K_{i,j,u,u} &+=& \dphi{x}\,\jw\,\deta\,\dgdu\,\p{4\dux+2\dvy}\\
  &+& \dphi{y}\,\jw\,\deta\,\dgdu\,\p{\duy+\dvx}\\
  &+& \dphi{z}\,\jw\,\deta\,\dgdu\,\duz;\\
  K_{i,j,u,v} &+=& \dphi{x}\,\jw\,\deta\,\dgdv\,\p{4\dux+2\dvy}\\
  &+& \dphi{y}\,\jw\,\deta\,\dgdv\,\p{\duy+\dvx}\\
  &+& \dphi{z}\,\jw\,\deta\,\dgdv\,\duz;\\
  K_{i,j,v,u} &+=& \dphi{y}\,\jw\,\deta\,\dgdu\,\p{4\dvy+2\dux}\\
  &+& \dphi{x}\,\jw\,\deta\,\dgdu\,\p{\duy+\dvx}\\
  &+& \dphi{z}\,\jw\,\deta\,\dgdu\,\dvz;\\
  K_{i,j,v,v} &+=& \dphi{y}\,\jw\,\deta\,\dgdv\,\p{4\dvy+2\dux}\\
  &+& \dphi{x}\,\jw\,\deta\,\dgdv\,\p{\duy+\dvx}\\
  &+& \dphi{z}\,\jw\,\deta\,\dgdv\,\dvz;\\
\end{eqnarray*}

\section{Residual}
\label{sec:residual}

\begin{eqnarray}
  \label{eq:4}
  F_{i,u} &=& \jw\, \left(\eta\, \left(\dphi{x}\, \p{4\dux + 2\dvy} + \dphi{y}\,
      \p{\duy + \dvx} + \dphi{z}\, \duz \right) + \varphi_{i}\, \rho\, g\, \diff{s}{x}\right),\\
  F_{i,v} &=& \jw\, \left(\eta\, \left(\dphi{y}\, \p{2\dux + 4\dvy} + \dphi{x}\, \p{\duy + \dvx} +
      \dphi{z}\, \dvz \right) + \varphi_{i}\, \rho\, g\, \diff{s}{y}\right).
\end{eqnarray}

\end{document}
